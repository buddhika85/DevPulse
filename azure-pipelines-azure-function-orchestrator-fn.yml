# Trigger this pipeline when code is pushed to the main branch
trigger:
  branches:
    include:
      - main

# Use a Microsoft-hosted agent with Windows OS
pool:
  vmImage: 'windows-latest'

# Define variables used throughout the pipeline
variables:
  - group: DevPulse-Backend-Secrets
  buildConfiguration: 'Release'
  functionProjectPath: 'backend/AzureFunctions/DevPulseOrchestratorFn/DevPulseOrchestratorFn.csproj'
  publishOutput: '$(Build.ArtifactStagingDirectory)/publish'

# Define the pipeline stage
stages:
- stage: BuildAndDeployFunction
  displayName: 'Build and Deploy Azure Function'
  jobs:
  - job: BuildAndDeploy
    displayName: 'Build and Deploy Job'
    steps:

    # Install .NET 8 SDK (required for isolated worker model)
    - task: UseDotNet@2
      displayName: 'Use .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
        installationPath: $(Agent.ToolsDirectory)/dotnet

    # Build and publish the Azure Function project
    - task: DotNetCoreCLI@2
      displayName: 'Publish Azure Function'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: '$(functionProjectPath)'
        arguments: '--configuration $(buildConfiguration) --output $(publishOutput)'

    # Deploy the published function to Azure
    - task: AzureFunctionApp@2
      displayName: 'Deploy to Azure Function App'
      inputs:
        azureSubscription: 'DevPulse-Azure-Connection'  # Azure service connection name configured in Azure DevOps to Azure subscription
        appType: 'functionApp'                          # Use 'functionAppLinux' if you're on Linux
        appName: 'devpulsefunctionapp'                  # Your Azure Function App name
        package: '$(publishOutput)'                     # Path to the published output

    # post-deployment verification step 1: Send a test message to the Service Bus topic to trigger the function
    - task: AzureCLI@2
      displayName: 'Send test message to Service Bus'
      inputs:
        azureSubscription: 'DevPulse-Azure-Connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az servicebus topic send \
            --resource-group DevPulseRG \
            --namespace-name devpulsebusns \
            --topic-name user-updates \
            --message-body '{"UserId": "a1b2c3d4-e5f6-7890-abcd-1234567890ef","UpdateField": "All","Message": "User updated","TimeStamp": "2025-11-13T04:00:00Z"}'
            --connection-string "$(ServiceBusConnectionString)"

    # post-deployment verification step 2: Tail logs to verify the function was triggered
    - task: AzureCLI@2
      displayName: 'Tail Azure Function logs'
      inputs:
        azureSubscription: 'DevPulse-Azure-Connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Waiting 10 seconds for function to process the message..."
          sleep 10
          az functionapp log tail \
            --name devpulsefunctionapp \
            --resource-group DevPulseRG \
            --output table \
            --limit 20