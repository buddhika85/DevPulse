# Trigger this pipeline when code is pushed to the main branch
trigger:
  branches:
    include:
      - main

# Use a Microsoft-hosted agent with Linux OS for better CLI compatibility
pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: DevPulse-Backend-Secrets     # Injects ServiceBusConnectionString securely
  - name: buildConfiguration
    value: 'Release'
  - name: functionProjectPath
    value: 'backend/AzureFunctions/DevPulseOrchestratorFn/DevPulseOrchestratorFn.csproj'
  - name: publishOutput
    value: '$(Build.ArtifactStagingDirectory)/publish'

# Define the pipeline stage
stages:
- stage: BuildAndDeployFunction
  displayName: 'Build and Deploy Azure Function'
  jobs:
  - job: BuildAndDeploy
    displayName: 'Build and Deploy Job'
    steps:

    # Install .NET 8 SDK (required for isolated worker model)
    - task: UseDotNet@2
      displayName: 'Use .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    # Build and publish the Azure Function project
    - task: DotNetCoreCLI@2
      displayName: 'Publish Azure Function'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: '$(functionProjectPath)'
        arguments: '--configuration $(buildConfiguration) --output $(publishOutput)'

    # Deploy the published function to Azure
    - task: AzureFunctionApp@2
      displayName: 'Deploy to Azure Function App'
      inputs:
        azureSubscription: 'DevPulse-Azure-Connection'
        appType: 'functionApp'
        appName: 'devpulsefunctionapp'
        package: '$(publishOutput)'

    # Send test message to Service Bus topic using PowerShell and .NET SDK
    - task: PowerShell@2
      displayName: 'Send test message to Service Bus topic'
      inputs:
        targetType: 'inline'
        script: |
          $ErrorActionPreference = 'Stop'
          $connectionString = "$(ServiceBusConnectionString)"
          $topicName = "user-updates"
          $messageBody = '{"UserId":"test-user","Action":"updated"}'

          # Create temp folder and minimal .NET console app
          $tempPath = "$(Build.ArtifactStagingDirectory)/sbSender"
          mkdir $tempPath | Out-Null
          cd $tempPath
          dotnet new console --framework net8.0 --output . | Out-Null
          dotnet add package Azure.Messaging.ServiceBus --version 7.16.1 | Out-Null

          # Write Program.cs manually
          $programCode = @'
using System;
using System.Threading.Tasks;
using Azure.Messaging.ServiceBus;

class Program {
    static async Task Main() {
        var conn = Environment.GetEnvironmentVariable("SB_CONN");
        var topic = "user-updates";
        var body = "{\"UserId\":\"a1b2c3d4-e5f6-7890-abcd-1234567890ef\",\"UpdateField\":\"All\",\"Message\":\"CI CD Triggered - User update message\",\"TimeStamp\":\"2025-11-13T04:00:00Z\"}";
        var client = new ServiceBusClient(conn);
        var sender = client.CreateSender(topic);
        var message = new ServiceBusMessage(body);
        await sender.SendMessageAsync(message);
        Console.WriteLine("✅ Test message sent. - CI CD Triggered test mesaage to Azure Service Bus Topic : user-updates");
    }
}
'@
          Set-Content -Path Program.cs -Value $programCode

          # Set env var and run
          $env:SB_CONN = $connectionString
          dotnet run

    # Post-deployment: Tail logs and fail if no recent execution is found
    - task: AzureCLI@2
      displayName: 'Tail Azure Function logs and verify'
      inputs:
        azureSubscription: 'DevPulse-Azure-Connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Waiting 10 seconds for function to process the message..."
          sleep 10
          LOGS=$(az functionapp log tail --name devpulsefunctionapp --resource-group DevPulseRG --limit 20 --output json 2>&1 | tee /tmp/function_logs.txt)
          if grep -q "Executing 'Functions." /tmp/function_logs.txt; then
            echo "✅ Function executed successfully."
          else
            echo "❌ No execution logs found. Function may not have triggered."
            exit 1
          fi