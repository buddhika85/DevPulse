trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
  - group: DevPulse-Backend-Secrets
  - name: buildConfiguration
    value: "Release"
  - name: functionProjectPath
    value: "backend/AzureFunctions/DevPulseOrchestratorFn/DevPulseOrchestratorFn.csproj"
  - name: publishOutput
    value: "$(Build.ArtifactStagingDirectory)/publish"
  - name: functionOutput
    value: "$(publishOutput)/DevPulseOrchestratorFn"

stages:
  - stage: BuildAndDeployFunction
    displayName: "Build and Deploy Azure Function"
    jobs:
      - job: BuildAndDeploy
        displayName: "Build and Deploy Job"
        steps:
          - task: UseDotNet@2
            displayName: "Install .NET 8 SDK"
            inputs:
              packageType: "sdk"
              version: "8.x"

          - task: DotNetCoreCLI@2
            displayName: "Publish Azure Function"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "$(functionProjectPath)"
              arguments: "--configuration $(buildConfiguration) --output $(publishOutput)"
              zipAfterPublish: false

          - script: |
              echo "Checking contents of: $(functionOutput)"
              ls -la "$(functionOutput)"

              if [ ! -f "$(functionOutput)/host.json" ]; then
                echo "❌ host.json not found. Deployment will fail."
                exit 1
              fi

              if [ ! -f "$(functionOutput)/functions.metadata" ]; then
                echo "❌ functions.metadata not found. Function will not be recognized."
                exit 1
              fi

              echo "✅ Required files found. Proceeding with deployment."
            displayName: "Validate publish output"

          - task: AzureFunctionApp@2
            displayName: "Deploy to Azure Function App"
            inputs:
              azureSubscription: "DevPulse-Azure-Connection"
              appType: "functionApp"
              appName: "devpulsefunctionapp"
              package: "$(functionOutput)"
              deploymentMethod: "zipDeploy"

          - task: PowerShell@2
            displayName: "Send test message to Service Bus"
            inputs:
              targetType: "inline"
              script: |
                $ErrorActionPreference = 'Stop'
                $connectionString = "$(ServiceBusConnectionString)"
                $tempPath = "$(Build.ArtifactStagingDirectory)/sbSender"
                mkdir $tempPath | Out-Null
                cd $tempPath
                dotnet new console --framework net8.0 --output . | Out-Null
                dotnet add package Azure.Messaging.ServiceBus --version 7.16.1 | Out-Null

                Add-Content Program.cs 'using System;'
                Add-Content Program.cs 'using System.Threading.Tasks;'
                Add-Content Program.cs 'using Azure.Messaging.ServiceBus;'
                Add-Content Program.cs ''
                Add-Content Program.cs 'class Program {'
                Add-Content Program.cs '    static async Task Main() {'
                Add-Content Program.cs '        var conn = Environment.GetEnvironmentVariable("SB_CONN");'
                Add-Content Program.cs '        var topic = "user-updates";'
                Add-Content Program.cs '        var body = $"{{\\"UserId\\":\\"a1b2c3d4-e5f6-7890-abcd-1234567890ef\\",\\"UpdateField\\":\\"All\\",\\"Message\\":\\"Published via CI/CD for testing : User updated\\",\\"TimeStamp\\":\\"{DateTime.UtcNow:O}\\"}}";'
                Add-Content Program.cs '        var client = new ServiceBusClient(conn);'
                Add-Content Program.cs '        var sender = client.CreateSender(topic);'
                Add-Content Program.cs '        var message = new ServiceBusMessage(body);'
                Add-Content Program.cs '        await sender.SendMessageAsync(message);'
                Add-Content Program.cs '        Console.WriteLine("✅ Test message sent.");'
                Add-Content Program.cs '    }'
                Add-Content Program.cs '}'

                $env:SB_CONN = $connectionString
                dotnet run

          - task: AzureCLI@2
            displayName: "Verify function execution in logs"
            inputs:
              azureSubscription: "DevPulse-Azure-Connection"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo "Waiting 10 seconds for function to process the message..."
                sleep 10
                LOGS=$(az functionapp log tail \
                  --name devpulsefunctionapp \
                  --resource-group DevPulseRG \
                  --limit 20 \
                  --output json 2>&1 | tee /tmp/function_logs.txt)

                if grep -q "Executing 'Functions." /tmp/function_logs.txt; then
                  echo "✅ Function executed successfully."
                else
                  echo "❌ No execution logs found. Function may not have triggered."
                  exit 1
                fi
