# Run this pipeline when code is pushed to main
trigger:
  branches:
    include:
      - main

# Use Ubuntu agent for compatibility
pool:
  vmImage: "ubuntu-latest"

# Define variables
variables:
  - group: DevPulse-Backend-Secrets # Inject ServiceBusConnectionString
  - name: buildConfiguration
    value: "Release"
  - name: functionProjectPath
    value: "backend/AzureFunctions/DevPulseOrchestratorFn/DevPulseOrchestratorFn.csproj"
  - name: publishOutput
    value: "$(Build.ArtifactStagingDirectory)/publish"
  - name: functionOutput
    value: "$(publishOutput)/DevPulseOrchestratorFn"

# Build and deploy steps
stages:
  - stage: BuildAndDeployFunction
    displayName: "Build and Deploy Azure Function"
    jobs:
      - job: BuildAndDeploy
        displayName: "Build and Deploy Job"
        steps:
          # Install .NET 8 SDK
          - task: UseDotNet@2
            displayName: "Install .NET 8 SDK"
            inputs:
              packageType: "sdk"
              version: "8.x"

          # Build and publish the function project
          - task: DotNetCoreCLI@2
            displayName: "Publish Azure Function"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "$(functionProjectPath)"
              arguments: "--configuration $(buildConfiguration) --output $(publishOutput)"
              zipAfterPublish: false

          # Check for required files in the publish folder
          - script: |
              echo "Checking contents of: $(functionOutput)"
              ls -la "$(functionOutput)"

              if [ ! -f "$(functionOutput)/host.json" ]; then
                echo "❌ host.json not found. Deployment will fail."
                exit 1
              fi

              if [ ! -f "$(functionOutput)/functions.metadata" ]; then
                echo "❌ functions.metadata not found. Function will not be recognized."
                exit 1
              fi

              echo "✅ Required files found. Proceeding with deployment."
            displayName: "Validate publish output"

          # Deploy to Azure Function App
          - task: AzureFunctionApp@2
            displayName: "Deploy to Azure Function App"
            inputs:
              azureSubscription: "DevPulse-Azure-Connection"
              appType: "functionApp"
              appName: "devpulsefunctionapp"
              package: "$(functionOutput)"
              deploymentMethod: "zipDeploy"

          # Send a test message to Service Bus
          - task: PowerShell@2
            displayName: "Send test message to Service Bus"
            inputs:
              targetType: "inline"
              script: |
                $ErrorActionPreference = 'Stop'
                $connectionString = "$(ServiceBusConnectionString)"
                $tempPath = "$(Build.ArtifactStagingDirectory)/sbSender"
                mkdir $tempPath | Out-Null
                cd $tempPath
                dotnet new console --framework net8.0 --output . | Out-Null
                dotnet add package Azure.Messaging.ServiceBus --version 7.16.1 | Out-Null

                echo 'using System;' > Program.cs
                echo 'using System.Threading.Tasks;' >> Program.cs
                echo 'using Azure.Messaging.ServiceBus;' >> Program.cs
                echo '' >> Program.cs
                echo 'class Program {' >> Program.cs
                echo '    static async Task Main() {' >> Program.cs
                echo '        var conn = Environment.GetEnvironmentVariable("SB_CONN");' >> Program.cs
                echo '        var topic = "user-updates";' >> Program.cs
                echo '        var body = $"{{\\"UserId\\":\\"a1b2c3d4-e5f6-7890-abcd-1234567890ef\\",\\"UpdateField\\":\\"All\\",\\"Message\\":\\"Published via CI/CD for testing : User updated\\",\\"TimeStamp\\":\\"{DateTime.UtcNow:O}\\"}}";' >> Program.cs
                echo '        var client = new ServiceBusClient(conn);' >> Program.cs
                echo '        var sender = client.CreateSender(topic);' >> Program.cs
                echo '        var message = new ServiceBusMessage(body);' >> Program.cs
                echo '        await sender.SendMessageAsync(message);' >> Program.cs
                echo '        Console.WriteLine("✅ Test message sent.");' >> Program.cs
                echo '    }' >> Program.cs
                echo '}' >> Program.cs

                $env:SB_CONN = $connectionString
                dotnet run

          # Check Azure logs to confirm function ran
          - task: AzureCLI@2
            displayName: "Verify function execution in logs"
            inputs:
              azureSubscription: "DevPulse-Azure-Connection"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo "Waiting 10 seconds for function to process the message..."
                sleep 10
                LOGS=$(az functionapp log tail \
                  --name devpulsefunctionapp \
                  --resource-group DevPulseRG \
                  --limit 20 \
                  --output json 2>&1 | tee /tmp/function_logs.txt)

                if grep -q "Executing 'Functions." /tmp/function_logs.txt; then
                  echo "✅ Function executed successfully."
                else
                  echo "❌ No execution logs found. Function may not have triggered."
                  exit 1
                fi
