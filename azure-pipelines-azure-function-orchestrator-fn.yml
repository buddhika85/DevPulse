# Trigger this pipeline when code is pushed to the main branch
trigger:
  branches:
    include:
      - main

# Use a Microsoft-hosted agent with Linux OS for better CLI compatibility
pool:
  vmImage: 'ubuntu-latest'

# Define variables used throughout the pipeline
variables:
  - group: DevPulse-Backend-Secrets  # Injects ServiceBusConnectionString securely
  buildConfiguration: 'Release'
  functionProjectPath: 'backend/AzureFunctions/DevPulseOrchestratorFn/DevPulseOrchestratorFn.csproj'
  publishOutput: '$(Build.ArtifactStagingDirectory)/publish'

# Define the pipeline stage
stages:
- stage: BuildAndDeployFunction
  displayName: 'Build and Deploy Azure Function'
  jobs:
  - job: BuildAndDeploy
    displayName: 'Build and Deploy Job'
    steps:

    # Install .NET 8 SDK (required for isolated worker model)
    - task: UseDotNet@2
      displayName: 'Use .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
        installationPath: $(Agent.ToolsDirectory)/dotnet

    # Build and publish the Azure Function project
    - task: DotNetCoreCLI@2
      displayName: 'Publish Azure Function'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: '$(functionProjectPath)'
        arguments: '--configuration $(buildConfiguration) --output $(publishOutput)'

    # Deploy the published function to Azure
    - task: AzureFunctionApp@2
      displayName: 'Deploy to Azure Function App'
      inputs:
        azureSubscription: 'DevPulse-Azure-Connection'
        appType: 'functionApp'
        appName: 'devpulsefunctionapp'
        package: '$(publishOutput)'

    # Placeholder: Send test message to Service Bus topic
    - script: |
        echo "üß™ Placeholder for Service Bus test message"
        echo "This step will be replaced with a real message sender using CLI or PowerShell"
      displayName: 'Send test Service Bus message (placeholder)'

    # Post-deployment: Tail logs and fail if no recent execution is found
    - task: AzureCLI@2
      displayName: 'Tail Azure Function logs and verify'
      inputs:
        azureSubscription: 'DevPulse-Azure-Connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Waiting 10 seconds for function to process the message..."
          sleep 10
          LOGS=$(az functionapp log tail \
            --name devpulsefunctionapp \
            --resource-group DevPulseRG \
            --limit 20 \
            --output json 2>&1 | tee /tmp/function_logs.txt)

          if grep -q "Executing 'Functions." /tmp/function_logs.txt; then
            echo "‚úÖ Function executed successfully."
          else
            echo "‚ùå No execution logs found. Function may not have triggered."
            exit 1
          fi