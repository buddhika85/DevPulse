# Trigger the pipeline when code is pushed to the 'main' branch
# trigger:
  # branches:
    # include:
      # - main

# Define reusable variables for ACR, ACA, and deployment settings
variables:
  acrLoginServer: devpulseacr-cta8h8feeua4cchz.azurecr.io                         # ACR Login server 
  imageName: orchestrator-api                                   # Docker image name
  resourceGroup: DevPulseRG                # Azure resource group
  containerAppName: orchestrator-api       # Azure Container App name
  location: australiaeast                  # Azure region
  tag: v1.0.0                              # Docker image tag

# Use a Microsoft-hosted Ubuntu agent to run the pipeline
pool:
  vmImage: ubuntu-latest

# Define the pipeline steps
steps:
  # Step 1: Build and push the image using ACR build service (avoids DNS resolution issues)
  - task: AzureCLI@2
    displayName: 'Build via ACR and Deploy to ACA'
    inputs:
      azureSubscription: 'DevPulse-SP-AzContainerReg-ACA'  # Azure service connection name configured in Azure DevOps
      scriptType: bash
      scriptLocation: inlineScript
      failOnStderr: true                                   # Fail the task if any CLI command throws an error
      inlineScript: |
        # Build and push image using Azure Container Registry build service
        echo "Building and pushing image via ACR..."
        az acr build \
          --registry $(acrLoginServer) \
          --image $(imageName):$(tag) \
          .

        # Deploy the new image to your Azure Container App
        echo "Deploying to Azure Container Apps..."
        az containerapp update \
          --name $(containerAppName) \
          --resource-group $(resourceGroup) \
          --image $(acrLoginServer)/$(imageName):$(tag)

  # Step 2: Warm up the ACA endpoint to avoid cold start latency
  - script: |
      echo "Warming up OrchestratorService..."
      for i in {1..10}; do
        response=$(curl -s -o /dev/null -w "%{http_code}" https://orchestrator-api.yellowcoast-35d1851f.australiasoutheast.azurecontainerapps.io/api/Health)
        echo "Attempt $i: HTTP $response"
        if [ "$response" -eq 200 ]; then
          echo "Success - Service is warm."
          break
        fi
        sleep 5
      done
    displayName: 'Warm up OrchestratorService after deploy'
    condition: succeeded()  # Only run this step if the previous deployment succeeded