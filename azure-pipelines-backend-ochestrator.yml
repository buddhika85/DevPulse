# Trigger the pipeline when code is pushed to the 'main' branch
trigger:
  branches:
    include:
      - main

# Define reusable variables for ACR, ACA, and deployment settings
variables:
  acrName: devpulseacr
  imageName: orchestrator-api
  resourceGroup: DevPulseRG
  containerAppName: orchestrator-api
  location: australiaeast
  tag: v1.0.0

# Use a Microsoft-hosted Ubuntu agent to run the pipeline
pool:
  vmImage: ubuntu-latest

# Define the pipeline steps
steps:
  # Step 1: Build, push, and deploy the container image to ACA
  - task: AzureCLI@2
    displayName: 'Build, Push, and Deploy to ACA'
    inputs:
      azureSubscription: 'DevPulse-SP-AzContainerReg-ACA'
      scriptType: bash
      scriptLocation: inlineScript
      failOnStderr: true
      inlineScript: |
        echo "Logging into ACR..."
        az acr login --name $(acrName)

        echo "Building Docker image..."
        docker build -t $(acrName).azurecr.io/$(imageName):$(tag) .

        echo "Pushing image to ACR..."
        docker push $(acrName).azurecr.io/$(imageName):$(tag)

        echo "Deploying to Azure Container Apps..."
        az containerapp update \
          --name $(containerAppName) \
          --resource-group $(resourceGroup) \
          --image $(acrName).azurecr.io/$(imageName):$(tag)

  # Step 2: Warm up the ACA endpoint to avoid cold start latency
  - script: |
      echo "Warming up OrchestratorService..."
      for i in {1..10}; do
        response=$(curl -s -o /dev/null -w "%{http_code}" https://orchestrator-api.yellowcoast-35d1851f.australiasoutheast.azurecontainerapps.io/api/Health)
        echo "Attempt $i: HTTP $response"
        if [ "$response" -eq 200 ]; then
          echo "Success - Service is warm."
          break
        fi
        sleep 5
      done
    displayName: 'Warm up OrchestratorService after deploy'
    condition: succeeded()