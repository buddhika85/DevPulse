# Trigger the pipeline when code is pushed to the 'main' branch
# trigger:
  # branches:
    # include:
      # - main

pool:
  vmImage: "ubuntu-latest"

variables:
  - group: DevPulse-Backend-Secrets

steps:
  # Install .NET SDK
  - task: UseDotNet@2
    inputs:
      packageType: "sdk"
      version: "8.0.x"
    displayName: "Install .NET SDK"

  # Restore UserService dependencies
  - script: dotnet restore backend/UserService/UserService.csproj
    displayName: "Restore UserService dependencies"

  # Build UserService
  - script: dotnet build backend/UserService/UserService.csproj --configuration Release
    displayName: "Build UserService"

  # # Run UserService tests
  # - script: dotnet test backend/UserService.Tests/UserService.Tests.csproj --configuration Release
  #   displayName: "Run UserService tests"
  # Publish UserService
  - script: dotnet publish backend/UserService/UserService.csproj --configuration Release --output $(Build.ArtifactStagingDirectory)/userservice
    displayName: "Publish UserService"
    # ArtifactStagingDirectory - itâ€™s a built-in Azure DevOps pipeline variable that points to a temporary folder on the build agent where your pipeline can stage files before publishing or deploying.

  # Deploy UserService to Azure App Service
  - task: AzureWebApp@1
    inputs:
      azureSubscription: "DevPulse-Azure-Connection" # Azure service connection name configured in Azure DevOps to Azure subscription
      appType: "webApp" # Specifies App Service type
      appName: "devpulse-user-api" # Targets the specific App Service
      package: "$(Build.ArtifactStagingDirectory)/userservice" # Points to the published output
    displayName: "Deploy UserService"

  # Warm up the App Service to avoid cold start latency - Retries up to 10 times with a 5-second delay, Checks for HTTP 200 to confirm readiness, - Avoids false positives from cold-start 503s or timeouts
  - script: |
      echo "Warming up UserService..."          
      for i in {1..10}; do                                      
        response=$(curl -s -o /dev/null -w "%{http_code}" https://devpulse-user-api-defhbme5gpabcced.australiasoutheast-01.azurewebsites.net/api/Health)
        echo "Attempt $i: HTTP $response"
        if [ "$response" -eq 200 ]; then
          echo "Success - Service is warm."
          break
        fi
        sleep 5
      done
    displayName: "Warm up UserService after deploy"
